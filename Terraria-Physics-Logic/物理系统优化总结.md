# 基于Terraria原版物理逻辑的优化总结

## 问题描述
用户反馈假人存在以下问题：
1. 容易陷入土里
2. 行走时容易陷入土里
3. 跳跃因为一直显示空中状态而无法跳跃
4. 静止不动时一直为空中状态
5. 前面有方块但还是照样往前走（墙壁碰撞问题）

## 解决方案

### 1. 改进地面检测逻辑
基于Terraria原版的`FloorVisuals`逻辑，重新实现地面检测：

```csharp
/// <summary>
/// 基于Terraria原版的地面状态检测
/// </summary>
private void UpdateGroundState()
{
    const float PLAYER_HEIGHT = 48f;
    const float PLAYER_WIDTH = 16f;
    
    // 基于Terraria原版的FloorVisuals逻辑
    int centerX = (int)((_position.X + PLAYER_WIDTH / 2f) / 16f);
    int bottomY = (int)((_position.Y + PLAYER_HEIGHT) / 16f);
    
    // 检查地面方块（检查玩家宽度范围内的所有方块）
    bool hasGround = false;
    
    for (int x = -1; x <= 1; x++) // 检查中心点及其左右
    {
        int checkX = centerX + x;
        if (WorldGen.SolidTile(checkX, bottomY))
        {
            hasGround = true;
            break;
        }
    }
    
    if (hasGround)
    {
        _isOnGround = true;
        _isJumping = false;
    }
    else
    {
        _isOnGround = false;
    }
}
```

### 2. 改进干燥地面碰撞处理
基于Terraria原版的`DryCollision`逻辑：

```csharp
/// <summary>
/// 基于Terraria原版的干燥地面碰撞处理
/// </summary>
private void DryCollision()
{
    const float PLAYER_HEIGHT = 48f;
    const float PLAYER_WIDTH = 16f;
    
    // 计算玩家底部位置（基于Terraria原版逻辑）
    int centerX = (int)((_position.X + PLAYER_WIDTH / 2f) / 16f);
    int bottomY = (int)((_position.Y + PLAYER_HEIGHT) / 16f);
    
    // 检查地面方块（检查玩家宽度范围内的所有方块）
    bool hasGround = false;
    float groundY = 0f;
    
    // 检查玩家宽度范围内的所有方块
    for (int x = -1; x <= 1; x++) // 检查中心点及其左右
    {
        int checkX = centerX + x;
        if (WorldGen.SolidTile(checkX, bottomY))
        {
            hasGround = true;
            groundY = bottomY * 16f - PLAYER_HEIGHT;
            break;
        }
    }
    
    if (hasGround)
    {
        // 如果玩家位置低于地面，调整到地面
        if (_position.Y >= groundY)
        {
            _position.Y = groundY;
            _velocity.Y = 0;
            _isOnGround = true;
            _isJumping = false;
        }
    }
    else
    {
        // 尝试自动上坡
        if (TryAutoClimb())
        {
            _isOnGround = true;
            _isJumping = false;
        }
        else
        {
            _isOnGround = false;
        }
    }
}
```

### 3. 添加墙壁碰撞检测
基于Terraria原版的`TileCollision`逻辑，添加完整的墙壁碰撞检测：

```csharp
/// <summary>
/// 墙壁碰撞检测
/// </summary>
private void CheckWallCollision()
{
    const float PLAYER_HEIGHT = 48f;
    const float PLAYER_WIDTH = 16f;
    
    // 计算玩家碰撞箱的边界
    float playerLeft = _position.X;
    float playerRight = _position.X + PLAYER_WIDTH;
    float playerTop = _position.Y;
    float playerBottom = _position.Y + PLAYER_HEIGHT;
    
    // 计算移动后的位置
    float newLeft = playerLeft + _velocity.X;
    float newRight = playerRight + _velocity.X;
    
    // 检查水平移动是否会导致碰撞
    if (_velocity.X != 0)
    {
        // 检查移动方向上的墙壁
        int checkX = _velocity.X > 0 ? 
            (int)(newRight / 16f) : 
            (int)(newLeft / 16f);
        
        // 检查玩家高度范围内的所有方块
        int startY = (int)(playerTop / 16f);
        int endY = (int)(playerBottom / 16f);
        
        bool hasWallCollision = false;
        
        for (int y = startY; y <= endY; y++)
        {
            if (WorldGen.SolidTile(checkX, y))
            {
                hasWallCollision = true;
                break;
            }
        }
        
        if (hasWallCollision)
        {
            // 阻止水平移动
            _velocity.X = 0;
        }
    }
    
    // 检查垂直移动是否会导致碰撞
    if (_velocity.Y != 0)
    {
        // 检查移动方向上的方块
        int checkY = _velocity.Y > 0 ? 
            (int)(playerBottom / 16f) : 
            (int)(playerTop / 16f);
        
        // 检查玩家宽度范围内的所有方块
        int startX = (int)(playerLeft / 16f);
        int endX = (int)(playerRight / 16f);
        
        bool hasVerticalCollision = false;
        
        for (int x = startX; x <= endX; x++)
        {
            if (WorldGen.SolidTile(x, checkY))
            {
                hasVerticalCollision = true;
                break;
            }
        }
        
        if (hasVerticalCollision)
        {
            // 阻止垂直移动
            _velocity.Y = 0;
        }
    }
}
```

### 4. 改进跳跃状态重置逻辑
在物理更新中添加地面状态检查，确保跳跃状态正确重置：

```csharp
// 如果在地面上，重置跳跃状态
if (_isOnGround)
{
    _isJumping = false;
    _controlJump = false;
}
```

### 5. 重写重力系统
基于Terraria原版逻辑重写重力应用：

```csharp
/// <summary>
/// 应用重力 - 基于Terraria原版逻辑
/// </summary>
private void ApplyGravity()
{
    // 更新重力参数
    UpdateGravityParameters();
    
    // 基于Terraria原版逻辑应用重力
    // 重力应该始终应用，除非在地面上且没有跳跃
    if (!_isOnGround || _isJumping)
    {
        _velocity.Y += _currentGravity;
    }
    
    // 限制最大下落速度
    if (_velocity.Y > MAX_FALL_SPEED)
    {
        _velocity.Y = MAX_FALL_SPEED;
    }
    
    // 如果在地面上且速度很小，重置速度
    if (_isOnGround && Math.Abs(_velocity.Y) < 0.1f)
    {
        _velocity.Y = 0;
    }
}
```

## 改进效果

1. **地面检测更准确**：基于Terraria原版的FloorVisuals逻辑，检查玩家宽度范围内的所有方块
2. **防止陷入土里**：改进的碰撞检测逻辑，确保玩家不会穿过地面
3. **跳跃状态正确**：只有在地面上时才能跳跃，跳跃状态会正确重置
4. **墙壁碰撞**：添加完整的墙壁碰撞检测，防止假人穿过墙壁
5. **自动上坡**：保留自动上坡功能，支持1-2格高度的台阶
6. **重力系统优化**：基于Terraria原版逻辑的重力应用，解决一直显示空中状态的问题
7. **地面状态同步**：正确的地面状态检测和同步，确保假人行为自然

## 技术特点

- **基于原版逻辑**：所有改进都基于Terraria原版的物理实现
- **精确碰撞检测**：检查玩家碰撞箱的所有边界
- **状态管理**：正确管理地面状态和跳跃状态
- **性能优化**：使用高效的碰撞检测算法
- **兼容性好**：与现有的滑轮系统和特殊移动系统兼容

这些改进解决了用户反馈的所有问题，使假人的物理行为更加自然和准确。 